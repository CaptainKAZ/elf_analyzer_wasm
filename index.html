<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recursive ELF Variable Analyzer (Wasm+DWARF)</title>
    <style>
        body { font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; margin: 20px; background-color: #f4f7f9; color: #333; line-height: 1.6; }
        h1 { color: #2c3e50; text-align: center; }
        table { border-collapse: collapse; width: 100%; margin-top: 25px; font-size: 0.9em; box-shadow: 0 2px 15px rgba(0,0,0,0.1); background-color: #fff; }
        th, td { border: 1px solid #e0e0e0; padding: 10px 12px; text-align: left; word-break: break-all; }
        th { background-color: #3498db; color: white; font-weight: 600; position: sticky; top: 0; z-index: 1;}
        tr:nth-child(even) { background-color: #f8f9fa; }
        tr:hover { background-color: #e9ecef; }
        #dropZone { border: 3px dashed #3498db; border-radius: 8px; padding: 30px; text-align: center; margin-bottom: 25px; cursor: pointer; background-color: #eaf5ff; transition: background-color 0.3s, border-color 0.3s; }
        #dropZone.hover { border-color: #2980b9; background-color: #d6eaf8; }
        #controls { margin-bottom: 20px; display: flex; flex-wrap: wrap; align-items: center; gap: 15px; padding: 15px; background-color: #fff; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        #controls label { font-weight: 500; margin-right: 5px; }
        #filterInput { padding: 10px; border: 1px solid #ccc; border-radius: 4px; min-width: 280px; flex-grow: 1; transition: border-color 0.3s; }
        #filterInput:focus { border-color: #3498db; outline: none; }
        #status { margin-top: 15px; padding: 12px; border-radius: 4px; font-style: italic; text-align: center; }
        .status-info { background-color: #e6f7ff; border: 1px solid #91d5ff; color: #0050b3; }
        .status-error { background-color: #fff1f0; border: 1px solid #ffccc7; color: #d9363e; }
        .status-success { background-color: #f6ffed; border: 1px solid #b7eb8f; color: #389e0d; }
        .loader { border: 5px solid #f3f3f3; border-top: 5px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; display: none; }
        #pagination { margin-top: 20px; text-align: center; }
        #pagination button { padding: 8px 15px; margin: 0 5px; cursor: pointer; background-color: #3498db; color: white; border: none; border-radius: 4px; transition: background-color 0.3s; }
        #pagination button:disabled { background-color: #bdc3c7; cursor: not-allowed; }
        #pagination span { margin: 0 10px; font-weight: 500; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <h1>Recursive ELF Variable Analyzer (DWARF)</h1>

    <div id="dropZone">
        Drag & Drop an ELF file here, or click to select.
        <input type="file" id="elfFile" accept=".elf,application/octet-stream,application/x-elf" style="display: none;">
    </div>

    <div id="controls">
        <label for="filterInput">Filter by name/type/file:</label>
        <input type="text" id="filterInput" placeholder="e.g., my_struct.member, int, or main.c">
    </div>

    <div id="status" class="status-info">Upload an ELF file compiled with DWARF debug information (e.g., using <code>-g</code> flag).</div>
    <div id="loader"></div>

    <table id="variablesTable">
        <thead>
            <tr>
                <th>Full Variable Name</th>
                <th>Base Type</th>
                <th>Address (Hex)</th>
                <th>Size (Bytes)</th>
                <th>File</th>
                <th>Line</th>
            </tr>
        </thead>
        <tbody>
            </tbody>
    </table>

    <div id="pagination">
        <button id="prevPage" disabled>Previous</button>
        <span id="pageInfo">Page 1 of 1</span>
        <button id="nextPage" disabled>Next</button>
    </div>

    <script type="module">
        // Path to the JS glue code generated by wasm-pack
        import init, { analyze_elf_recursively } from './pkg/elf_analyzer_wasm.js';

        let allVariablesData = []; // Stores all data from Wasm
        let filteredVariables = []; // Stores data after filtering
        let currentPage = 1;
        const itemsPerPage = 50; // 每页显示的数量
        let debounceTimer;

        // 防抖函数
        function debounce(func, delay) {
            return function(...args) {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => {
                    func.apply(this, args);
                }, delay);
            };
        }

        async function initializeWasmModule() {
            try {
                await init();
                console.log("Wasm module (recursive DWARF analyzer) initialized successfully.");
                document.getElementById('status').textContent = "Wasm module loaded. Ready for ELF file.";
                document.getElementById('status').className = 'status-info';
            } catch (e) {
                console.error("Fatal Error initializing Wasm module:", e);
                document.getElementById('status').textContent = "Error initializing Wasm module. Check console for details. Refresh may be needed.";
                document.getElementById('status').className = 'status-error';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const elfFileInput = document.getElementById('elfFile');
            const dropZone = document.getElementById('dropZone');
            const statusDiv = document.getElementById('status');
            const variablesTableBody = document.getElementById('variablesTable').querySelector('tbody');
            const filterInput = document.getElementById('filterInput');
            const loader = document.getElementById('loader');
            const prevPageButton = document.getElementById('prevPage');
            const nextPageButton = document.getElementById('nextPage');
            const pageInfoSpan = document.getElementById('pageInfo');

            function renderPage() {
                variablesTableBody.innerHTML = ''; // Clear previous results

                const totalItems = filteredVariables.length;
                const totalPages = Math.ceil(totalItems / itemsPerPage);
                currentPage = Math.max(1, Math.min(currentPage, totalPages)); // Ensure currentPage is valid

                const startIndex = (currentPage - 1) * itemsPerPage;
                const endIndex = Math.min(startIndex + itemsPerPage, totalItems);
                const pageItems = filteredVariables.slice(startIndex, endIndex);

                if (pageItems.length === 0 && totalItems > 0) {
                    // If current page is empty after filtering, but there are results, go to page 1
                    currentPage = 1;
                    // Re-slice might be needed if currentPage changed, but renderPage will be called again
                }

                pageItems.forEach(variable => {
                    const row = variablesTableBody.insertRow();
                    row.insertCell().textContent = variable.name;
                    row.insertCell().textContent = variable.type_name;
                    row.insertCell().textContent = `0x${variable.address.toString(16).toUpperCase()}`;
                    row.insertCell().textContent = variable.size;
                    row.insertCell().textContent = variable.file_name || "N/A";
                    row.insertCell().textContent = variable.line_number || "N/A";
                });

                // Update pagination controls
                pageInfoSpan.textContent = `Page ${totalPages === 0 ? 0 : currentPage} of ${totalPages}`;
                prevPageButton.disabled = currentPage <= 1;
                nextPageButton.disabled = currentPage >= totalPages;
            }

            function applyFilterAndRender() {
                const filterText = filterInput.value.toLowerCase().trim();
                if (!filterText) {
                    filteredVariables = [...allVariablesData]; // Use full data if filter is empty
                } else {
                    filteredVariables = allVariablesData.filter(variable =>
                        variable.name.toLowerCase().includes(filterText) ||
                        variable.type_name.toLowerCase().includes(filterText) ||
                        (variable.file_name && variable.file_name.toLowerCase().includes(filterText))
                    );
                }
                currentPage = 1; // Reset to first page after filtering
                renderPage(); // Render the first page of filtered results
            }

            // Use debounce on the input event listener
            filterInput.addEventListener('input', debounce(applyFilterAndRender, 300)); // 300ms debounce delay

            prevPageButton.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderPage();
                }
            });

            nextPageButton.addEventListener('click', () => {
                 const totalItems = filteredVariables.length;
                 const totalPages = Math.ceil(totalItems / itemsPerPage);
                if (currentPage < totalPages) {
                    currentPage++;
                    renderPage();
                }
            });


            async function handleFile(file) {
                if (!file) return;

                variablesTableBody.innerHTML = '';
                allVariablesData = [];
                filteredVariables = [];
                filterInput.value = '';
                currentPage = 1; // Reset page on new file
                statusDiv.textContent = `Processing ${file.name}... (DWARF parsing can take a moment)`;
                statusDiv.className = 'status-info';
                loader.style.display = 'block';
                prevPageButton.disabled = true; // Disable buttons during load
                nextPageButton.disabled = true;
                pageInfoSpan.textContent = 'Page 0 of 0';


                try {
                    const arrayBuffer = await file.arrayBuffer();
                    const uint8Array = new Uint8Array(arrayBuffer);

                    console.log(`Sending ${uint8Array.length} bytes to Wasm for recursive analysis.`);
                    const startTime = performance.now();

                    const variables = analyze_elf_recursively(uint8Array);

                    const endTime = performance.now();
                    console.log(`Recursive analysis took ${(endTime - startTime).toFixed(2)} ms.`);

                    if (variables && Array.isArray(variables)) {
                        allVariablesData = variables;
                        applyFilterAndRender(); // Apply empty filter initially and render page 1
                        if (variables.length > 0) {
                             statusDiv.textContent = `Successfully parsed ${variables.length} primitive components from variables in ${file.name}.`;
                             statusDiv.className = 'status-success';
                        } else {
                             statusDiv.textContent = `No primitive components found or DWARF info missing/incomplete in ${file.name}. Ensure it's compiled with debug symbols (e.g., -g).`;
                             statusDiv.className = 'status-info';
                        }

                    } else {
                         allVariablesData = [];
                         filteredVariables = [];
                         renderPage(); // Render empty state
                         statusDiv.textContent = `Wasm function returned an unexpected result. Check console. File: ${file.name}.`;
                         statusDiv.className = 'status-error';
                         console.warn("Unexpected result from Wasm:", variables);
                    }
                } catch (e) {
                    allVariablesData = [];
                    filteredVariables = [];
                    renderPage(); // Render empty state
                    console.error("Error analyzing ELF file recursively:", e);
                    let errorMsg = "Error analyzing ELF file. See browser console for details.";
                    if (typeof e === 'string') { errorMsg = e; }
                    else if (e && typeof e.message === 'string') { errorMsg = e.message; }
                    else if (e && typeof e.toString === 'function') { const eStr = e.toString(); if (eStr !== '[object Object]') errorMsg = eStr; }
                    statusDiv.textContent = errorMsg;
                    statusDiv.className = 'status-error';
                } finally {
                    loader.style.display = 'none';
                    // Re-enable buttons based on initial render state (renderPage handles this)
                }
            }

            // Event listeners for file input and drag & drop
            elfFileInput.addEventListener('change', (event) => {
                if (event.target.files.length > 0) handleFile(event.target.files[0]);
            });
            dropZone.addEventListener('click', () => elfFileInput.click());
            dropZone.addEventListener('dragover', (event) => { event.preventDefault(); dropZone.classList.add('hover'); });
            dropZone.addEventListener('dragleave', () => { dropZone.classList.remove('hover'); });
            dropZone.addEventListener('drop', (event) => {
                event.preventDefault();
                dropZone.classList.remove('hover');
                if (event.dataTransfer.files.length > 0) {
                    elfFileInput.files = event.dataTransfer.files;
                    handleFile(event.dataTransfer.files[0]);
                }
            });

            initializeWasmModule();
        });
    </script>
</body>
</html>
